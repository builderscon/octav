apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: octav-slackgw-deployment
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: slackgw
        group: octav
    spec:
      volumes:
        - name: certificates
          secret:
            secretName: ca-certificates
        - name: slack
          secret:
            secretName: slack-dev
        - name: google
          secret:
            secretName: google-dev
        - name: k8s-fifo
          emptyDir:
            medium: Memory
        - name: octav-clone
          gitRepo:
            repository: git://github.com/builderscon/octav.git
            revision: 24b6e08
      containers:
        # Talks to slack, accepts requests to post to slack
        - image: asia.gcr.io/builderscon-1248/slackgw:20160420.200951
          name: slackgw
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          ports:
            - name: http
              containerPort: 4979
              protocol: TCP
          args:
            - -listen
            - 0.0.0.0:4979
            - -rtm
            - gpubsub-forward
            - -gpubsub-forward.project_id
            - builderscon-1248
            - -gpubsub-forward.event
            - MessageEvent
            - -gpubsub-forward.topic
            - slackgw-forward
            - -tokenfile
            - /slack/token
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /google/servicekey
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: google
              readOnly: true
              mountPath: /google
            - name: slack
              readOnly: true
              mountPath: /slack
        # Listens to google pubsub, routes the messages to the
        # appropriate worker
        - image: asia.gcr.io/builderscon-1248/slackrouter
          name: slackrouter
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          args:
            - -project_id
            - builderscon-1248
            - -slackgw
            - http://slackgw:4979
            - -topic
            - slacgw-subscribe
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /google/servicekey
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: google
              readOnly: true
              mountPath: /google
        # Listens to google pubsub, does the acme stuff
        - image: asia.gcr.io/builderscon-1248/acmebot
          name: acmebot
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          args:
            - -email
            - lestrrat@gmail.com
            - -fifopath
            - /k8s-fifo/acmebot.fifo
            - -project_id
            - builderscon-1248
            - -slackgw
            - http://slackgw:4979
            - -topic
            - acmebot-subscribe
            - -zone
            - builderscon
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /google/servicekey
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: google
              readOnly: true
              mountPath: /google
            - name: k8s-fifo
              readOnly: false
              mountPath: /k8s-fifo
        # Auxilary tool to listen to fifo and push secrets to k8s
        - image: asia.gcr.io/builderscon-1248/acmebot-k8s
          name: acmebot-k8s
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          args:
            - -slackgw
            - http://slackgw:4979
            - -fifopath
            - /k8s-fifo/acmebot.fifo
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: k8s-fifo
              readOnly: false
              mountPath: /k8s-fifo
        # Listens to google pubsub, does deployment
        - image: asia.gcr.io/builderscon-1248/deploybot:20160420.152545
          name: deploybot
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          args:
            - -email
            - lestrrat@gmail.com
            - -fifopath
            - /k8s-fifo/deploybot.fifo
            - -project_id
            - builderscon-1248
            - -slackgw
            - http://slackgw:4979
            - -topic
            - deploybot-subscribe
            - -zone
            - builderscon
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /google/servicekey
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: google
              readOnly: true
              mountPath: /google
            - name: k8s-fifo
              readOnly: false
              mountPath: /k8s-fifo
        # Auxilary tool to listen to fifo and push secrets to k8s
        - image: asia.gcr.io/builderscon-1248/deploybot-k8s:20160421.105715
          name: deploybot-k8s
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          args:
            - -slackgw
            - http://slackgw:4979
            - -fifopath
            - /k8s-fifo/deploybot.fifo
            - -root
            - /git/octav/gke
            - -project_id
            - builderscon-1248
            - -zone
            - builderscon
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /google/servicekey
          volumeMounts:
            - name: certificates
              readOnly: true
              mountPath: /etc/ssl/certs
            - name: google
              readOnly: true
              mountPath: /google
            - name: k8s-fifo
              readOnly: false
              mountPath: /k8s-fifo
            - name: octav-clone
              mountPath: /git

